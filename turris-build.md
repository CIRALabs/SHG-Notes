X-Gm-Message-State: APjAAAV03YIc6IF1mtptdS/XZuNNx2Y2C87vMRZKsVKX5XUwopjqdXqY
	5jHdoafMqp8NLsu9K2s/3RxYcJnbn0w=
Subject: Re: Turris OS build?
To: Kathy Giori <kgiori@mozilla.com>
Cc: Dave Hylands <dhylands@mozilla.com>, Michael Richardson <mcr@sandelman.ca>
From: Audric Schiltknecht <audric.schiltknecht@viagenie.ca>
Autocrypt: addr=audric.schiltknecht@viagenie.ca; prefer-encrypt=mutual;
 keydata=
 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
 LdWUGglO5KoKgDHl0cIO/dDkjw==
Date: Thu, 28 Mar 2019 09:58:48 -0400
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.5.1
X-CanItPRO-Stream: sandelman-ca:mcr (inherits from sandelman-ca:default,rp-01:default,base:default)
X-Canit-Stats-ID: 0gXRpWOIX - d8489496378d - 20190328
X-Antispam-Training-Forget: https://emailfilteringservice.net/canit/b.php?c=f&i=0gXRpWOIX&m=d8489496378d&rlm=sandelman-ca&t=20190328
X-Antispam-Training-Nonspam: https://emailfilteringservice.net/canit/b.php?c=n&i=0gXRpWOIX&m=d8489496378d&rlm=sandelman-ca&t=20190328
X-Antispam-Training-Phish: https://emailfilteringservice.net/canit/b.php?c=p&i=0gXRpWOIX&m=d8489496378d&rlm=sandelman-ca&t=20190328
X-Antispam-Training-Spam: https://emailfilteringservice.net/canit/b.php?c=s&i=0gXRpWOIX&m=d8489496378d&rlm=sandelman-ca&t=20190328
X-CanIt-Archive-Cluster: irqpXI7aJGyo4Ewta7qVH399FOg

Hello,

On 19-03-28 06 h 51, Michael Richardson wrote:
> 
> Kathy Giori <kgiori@mozilla.com> wrote:
>     > On copy is our lead Mozilla gateway => OpenWrt integrator and
>     > builder. He has run into a few issues trying to build OpenWrt with our
>     > gw image installed. Do you guys have a process or any tricks to create
>     > a single installable image that works?
> 
> Hey, Audric is successfully built the "medkit" image from scratch.
> He is on the CC.   Our image is at:
>    https://www.viagenie.ca/cira-shg/medkit/

I do not have the whole context for your project, so here are some hints of what has been done for SHG.

SHG is based on cz.nic's Turris Omnia routeur.

We had to update cz.nic's medkit builder (https://gitlab.labs.nic.cz/turris/turris-build.git) to
have it generate the medkit. There is a script that will create the image by downloading and
installing pre-built packages from cz.nic's repositories (same feeds as what is configured on the
router) into a fakeroot rootfs. Repository list and installed packages are tweaked by providing the
script some configuration file.
It appears to be possible to use another script provided in the same repo to recompile the whole
image from scratch (checkout'ing Openwrt sources, applying patches, etc), but we have not managed to
have it work.

As mentioned, you need to have built packages for generating the medkit. In order to do that, we
currently use 2 methods:
- For non-kernel dependent packages: we use the SDK
(https://repo.turris.cz/omnia-hbk/turrisos-sdk-4.0-mvebu-cortexa9_gcc-7.3.0_musl_eabi.Linux-x86_64.tar.xz).
If you have some "base dependencies" (packages only present in the "packages" directory in the
openwrt repository, not as a separate feed), then you will need to link or add these packages
manually. This allows us to build modified/new packages with the same dependencies used in the
Turris image.
- For kernel dependent ones, we reverted to a vanilla OpenWRT checkout, pined on the version used in
the Turris (v18.06.2).

This is very crude and manual for now, but currently works OK. Planing to improve it for next phase.

Not sure if this will be helpful or not, but if you have further questions, do not hesitate!

Audric
